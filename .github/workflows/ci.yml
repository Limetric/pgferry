name: CI

on:
  push:
    branches: ["*"]
    tags: ["v*"]
  pull_request:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - run: go vet ./...
      - run: go test ./... -count=1

  integration-mysql:
    runs-on: ubuntu-latest
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - mysql: "5.7"
            postgres: "14"
          - mysql: "5.7"
            postgres: "latest"
          - mysql: "8.0"
            postgres: "latest"
          - mysql: "lts"
            postgres: "17"
          - mysql: "lts"
            postgres: "latest"
          - mysql: "latest"
            postgres: "latest"
    services:
      mysql:
        image: mysql:${{ matrix.mysql }}
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: pgferry_test
        ports:
          - "3306:3306"
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      postgres:
        image: postgres:${{ matrix.postgres }}
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pgferry_test
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      MYSQL_DSN: "root:root@tcp(127.0.0.1:3306)/pgferry_test"
      POSTGRES_DSN: "postgres://postgres:postgres@127.0.0.1:5432/pgferry_test?sslmode=disable"
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - run: go test -tags integration -count=1 -v -run TestIntegration_MySQL ./...

  integration-sqlite:
    runs-on: ubuntu-latest
    needs: test
    strategy:
      fail-fast: false
      matrix:
        postgres: ["14", "15", "16", "17", "18"]
    services:
      postgres:
        image: postgres:${{ matrix.postgres }}
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pgferry_test
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      POSTGRES_DSN: "postgres://postgres:postgres@127.0.0.1:5432/pgferry_test?sslmode=disable"
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - run: go test -tags integration -count=1 -v -run TestIntegration_SQLite ./...

  build:
    runs-on: ubuntu-latest
    needs: [test, integration-mysql, integration-sqlite]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - run: go build -ldflags="-X main.buildVersion=dev -X main.buildCommit=${GITHUB_SHA}" -o pgferry .

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          ext=""
          if [ "$GOOS" = "windows" ]; then ext=".exe"; fi
          out="pgferry-${GOOS}-${GOARCH}${ext}"
          go build -ldflags="-s -w -X main.buildVersion=${GITHUB_REF_NAME} -X main.buildCommit=${GITHUB_SHA}" -o "$out" .
          echo "ARTIFACT=$out" >> "$GITHUB_ENV"
      - name: Upload release binary
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ARTIFACT }}
